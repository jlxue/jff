                                CONTACT:    yubao.liu at gmail.com
                                            Dieken at newsmth BBS


+ HOW TO USE +


++ OS Installation ++

1) Install Debian Wheezy base system, use host name "gold", domain
name "corp.example.com";

$ cat /etc/hostname
gold
$ cat /etc/hosts
127.0.0.1   localhost
127.0.1.1   gold.corp.example.com gold

# The following lines are desirable for IPv6 capable hosts
::1     ip6-localhost ip6-loopback
fe00::0 ip6-localnet
ff00::0 ip6-mcastprefix
ff02::1 ip6-allnodes
ff02::2 ip6-allrouters


++ Network Configuration ++

2) Use static network configuration in /etc/network/interfaces:

iface eth0 inet static
    address 10.0.0.10
    netmask 255.255.255.0
    gateway 10.0.0.1
    dns-nameservers 127.0.0.1
    dns-search corp.example.com

Check /etc/resolv.conf, this should be setup properly by resolvconf
and ifupdown packages:
$ cat /etc/resolv.conf
search corp.example.com
nameserver 127.0.0.1

NOTICE: If you DON'T use 10.0.0.10 for the "gold" server, adjust
./etc/bind/db.{corp,10} ./etc/bind/zones.rfc1918 and
/etc/network/interfaces, then run ./dns.sh to sync configuration to
/etc/bind/ directory.

Make sure "nslookup 10.0.0.10" returns "gold.corp.example.com"
and "nslookup gold.corp.example.com" returns "10.0.0.10".

!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!! YOU MUST configure the network as described above, or you probably
!!! CAN'T access services below from outside of the server itself.
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!


++ Service Installation ++

3) Run ./run.sh as root user, it may fail, fix errors and run ./run.sh
again until all are OK.

$ cat /etc/resolv.conf
# Dynamic resolv.conf(5) file for glibc resolver(3) generated by resolvconf(8)
#     DO NOT EDIT THIS FILE BY HAND -- YOUR CHANGES WILL BE OVERWRITTEN
search corp.example.com
nameserver 127.0.0.1
# for failover in case bind9 on 127.0.0.1 is not available
#nameserver 8.8.8.8
#nameserver 8.8.4.4


++ OpenLDAP Configuration ++

4) As root, run:
    # service slapd start
    # ldapmodify -Y EXTERNAL -H ldapi:/// -c -f ldap-mods.ldif
    # service slapd restart


++ Kerberos Configuration ++

5.1) Create Kerberos users (*/ldap are administrators of OpenLDAP server):
    # kadmin.local
    kadmin.local: addprinc -policy user dieken
    kadmin.local: addprinc -policy user jack
    kadmin.local: addprinc -policy admin dieken/ldap

5.2) Suppose "dieken" is the first local normal user with uid=1000,
     "jack" is a user stored in OpenLDAP, run these commands as root
     to create user "jack":

     Check /etc/krb5.conf, /etc/ldap/ldap.conf and /etc/ldapscripts/ldapscripts.conf
     whether they are same with ./etc/krb5.conf, ./etc/ldap/ldap.conf and
     ./etc/ldapscripts/ldapscripts.conf.

    # kinit dieken/ldap
    # /usr/sbin/ldapinit
    # /usr/sbin/ldapaddgroup jack
    # /usr/sbin/ldapadduser jack jack
    # mkdir /home/jack; chown jack:jack /home/jack  # required by Dovecot
    # kdestroy
    # getent passwd | grep jack


++ Exim Configuration ++

6) Run /usr/share/doc/exim4-base/examples/exim-gencert to generate
certificates for Exim if you can't get CA issued certificates, the
"Server name" must be "smtp.corp.example.com".

    ## Dovecot >= 2.0.18, due to these patches:
    ## http://hg.dovecot.org/dovecot-2.0/rev/bed15faedfd4 auth: Check also masterdbs when checking if auth mechanism can be used.
    ## http://hg.dovecot.org/dovecot-2.0/rev/525a179f324f auth: DIGEST-MD5 didn't read nonce-count parameter correctly.
    ## http://hg.dovecot.org/dovecot-2.0/rev/847ca219989d auth: DIGEST-MD5 supports authorization id now.


++ Mailman Configuration ++

7.1) Run "newlist mailman" as root, it will ask you to set admin email
address and password for the "mailman" mailing list.

Optional:
    You may want to fix broken mailing list url if you have lists created before:
        http://mail.python.org/pipermail/mailman-users/2008-January/060106.html
        The with_list script: # withlist -l -r fix_url LISTNAME -u NEW-DOMAIN
        For example: # withlist -l -r fix_url mailman --urlhost list.corp.example.com

        http://mail.python.org/pipermail/mailman-users/2002-September/022781.html
        The config_list script.

    And you may have to modify these files manually to fix bad links:
    /var/lib/mailman/archives/public/mailman/index.html
    /var/lib/mailman/archives/private/mailman/index.html

7.2) Run "mmsitepass" as root, it's required to create new list on mailman Web UI.

7.3) Fix file permission:
# chown www-data:list /var/lib/mailman/archives/private
# chgrp -R list /var/lib/mailman/archives/private

7.3) Restart apache2 and mailman services.


++ Darwin CalendarServer Configuration ++

8) The file system where /var/spool/davcald sits must be mounted with
"user_xattr" option enabled.


++ DAViCal Configuration ++

9) Turn off Kerberos authentication in /etc/apache2/sites-enabled/davical
and restart Apache, then run this command as root user to find out
admin's default password:
    # su postgres -c "psql davical -c 'select username, password from usr;'"
    (the password is the bit after the '**' in the 'password' field)

Login http://cal.corp.example.com/ with "admin" account, create a user
for your Kerberos account, for example, "dieken".

Turn on Kerberos authentication now, and use "kinit" to obtain Kerberos
ticket, then restart Apache, use Firefox to access http://cal.corp.example.com/,
if you have setup Negotiate authentication for your Firefox browser, you will
find you can login without password.


++ Mantis Configuration ++

10.1) Comment "$g_login_method = BASIC_AUTH" in /srv/www/mantis/config_inc.php
      then restart Apache2.

10.2) Access "http://bug.corp.example.com/admin/install.php" to finish
installation, you don't have to input anything in the input fields,
just click the "Install/Upgrade Database" button.

Notice the default admin account is "administrator" with password "root".

You may need to adjust default timezone in /etc/php5/cgi/php.ini:
    date.timezone = Asia/Chongqing
See http://php.net/manual/en/function.date-default-timezone-set.php

10.3) Create a new admin account "dieken" on Mantis management page,

10.4) Access dieken's email, Mantis will send an activation email,
click the link in it to activate the account. You don't have to
input anything or click any button on the activation page.

10.5) DO FINISH STEP 10.4, OR you CAN'T login with both two accounts!

Uncomment "$g_login_method = BASIC_AUTH" in /srv/www/mantis/config_inc.php,
then restart Apache, use "kinit" to obtain Kerberos ticket, if you have
setup Negotiate authentication for your Firefox browser, you will find
you can login without the "/login_page.php" page.


++ Bugzilla Configuration ++

11) Run these commands as root to setup Bugzilla database and configuration:
    # cd /srv/www/bugzilla
    # ./checksetup.pl


++ Foswiki Configuration ++

12.1) Optional, run these commands to install optional modules:
    # cd /srv/www/foswiki/bin
    # ../tools/dependencies_installer.pl
    # chown -R www-data:www-data /srv/www/foswiki

12.2) add your user name to "admin" group in /srv/www/foswiki/data/admin-group:

admin: dieken

Restart Apache, access http://wiki.corp.example.com/bin/configure .


++ MoinMoin Configuration ++

13) Access http://moin.corp.example.com/LanguageSetup to install
    language pack, then RESTART Apache service.


++ ejabberd Configuration ++

14) Run this command to register a new user:
    # ejabberdctl register dieken corp.example.com `pwgen -cnys 64 1`

    You can use the password or your Kerberos ticket to login with Pidgin.

    Access http://xmpp.corp.example.com/admin with username
    "dieken@corp.example.com" and the password above to manage this
    ejabberd service, notice some options are cleared by
    /etc/ejabberd/ejabberd.cfg due to "override_*" directives.

NOTICE GSSAPI SASL authentication is included in ejabberd 3.0 which
isn't released yet, see http://www.ejabberd.im/cyrsasl_gssapi .


++ Samba Configuration ++

15) Use "pdbedit" to add user.


++ Subversion Configuration ++

16) Create repository:
    # svnadmin create /srv/svn/REPOS_NAME
    # chown -R svn:svn /srv/svn/REPOS_NAME


++ Trac Configuration ++

17) Create a project environment:
  # trac-admin /srv/trac/First initenv
  # chown -R trac:trac /srv/trac/First

  Access it at http://trac.corp.example.com/ .


++ Redmine Configuration ++

18) Access "http://redmine.corp.example.com/" after you obtain Kerberos
    ticket, this will automatically add your Kerberos account into
    Redmine's internal user table.

    Turn off Kerberos authentication in /etc/apache2/sites-enabled/redmine,
    then RESTART Apache2, access "http://redmine.corp.example.com/" again,
    login with admin role(login name and default password: admin/admin),
    in the "Administration" page, set the normal user automatically
    created above administrator role.

    Turn on Kerberos authentication in /etc/apache2/sites-enabled/redmine,
    now you can throw away the default "admin" account in Redmine.


++ Drupal Configuration ++

19.1) Access "http://www.corp.example.com/install.php" to finish installation.

19.2) Enable "WebserverAuth" module in administration panel after installation.


++ Zabbix Configuration ++

20.1) Access "http://monitor.corp.example.com/zabbix/", login with
      default admin account: Admin/zabbix.

      Configuration -> Hosts:
      Enable the zabbix server to be monitored and change its name to short
      hostname obtained by "hostname" command: Configuration -> Hosts.

20.2) Change Admin account's password or create new admin account.


++ ReviewBoard Configuration ++

21.1) Run this command to change password for 'dieken' super user:
    # /usr/local/bin/rb-site manage /srv/www/ReviewBoard/ changepassword dieken

21.2) Login http://codereview.corp.example.com/ with user 'dieken'.
      Check its 'Admin' link to configure the site, especially about
      Email and Repositories:

      Admin -> Settings -> E-Mail:
        Select "Send e-mails for review requests and reviews"
        Select "Send e-mails when new users register an account"

        Mail Server: smtp.corp.example.com  (This is using STARTTLS + CRAM-MD5 authentication mechanism)
        Port       : 25
        Username   : reviewboard@corp.example.com
        Password   : [[ check with "db_dump -p /etc/exim4/sasldb2" ]]

        Select "Use TLS for authentication"


      Admin -> Dashboard -> Repositories: (click "Add" on right)
        Name:               svn://svn.corp.example.com/test
        Hosting service:    Custom
        Repository type:    Subversion
        Path:               svn://svn.corp.example.com/test
        Username:           reviewboard
        Password:           [[ check with "db_dump -p /srv/svn/sasldb2" ]]

        Bug Tracker:
            Type:   Bugzilla
            URL:    http://bugzilla.corp.example.com

            (Trac: http://trac.corp.example.com/PROJECT_NAME)
            (Redmine: http://redmine.corp.example.com)


++ Gitolite Configuration ++

22.1) If you *ONLY* want http access to the repositories:
        # su git
        $ gitolite setup --admin dieken

      If you want SSH access, first generate the gitolite admin's ssh key:
        $ ssh-keygen -t ecdsa -b 521 -f dieken
      This generates two files, "dieken" is private key, "dieken.pub" is public key.

      Then:

        # su git
        $ gitolite setup --pubkey /path/to/dieken.pub

22.2) Add this line to conf/gitolite.conf for all gitweb visible
      repositories in gitolite-admin repository:

      R = gitweb daemon

      For example:
      $ git clone git.corp.example.com:gitolite-admin
      $ cd gitolite-admin
      $ vim conf/gitolite.conf
      $ cat conf/gitolite.conf
        repo gitolite-admin
            RW+     =   dieken

        repo testing
            RW+     =   @all

        repo myserver
            RW+     =   dieken
            R       =   daemon gitweb
      $ git commit -a -m "make repository \"myserver\" visible on gitweb"


++ Gerrit Configuration ++

    NOTICE: Gerrit < 2.5 has a bug in STARTTLS which will make Gerrit
            fail to send email. See http://code.google.com/p/gerrit/issues/detail?id=1397

23.1) Access http://gerrit.corp.example.com/#/admin/projects/ to register
      email for the first user, the first user is the administrator.
      If Gerrit doesn't show you the Registration page, you can reach
      it by clicking "settings" link in the top right corner and then
      clicking "Contact Information" on the left. For example:

        Full Name: Dieken
        Preferred Email: dieken@corp.example.com

      Then go to your email box, click the link contained in the
      Gerrit email, this will activate the email address in Gerrit.
      You need to fill your full name again in "Contact Information"
      and save it, so the change will be reflected in the "Profile".


=============================================================
Passwords:

1) Password for local user "root" and "dieken"
2) Password for Kerberos principal "dieken", "dieken/ldap", "jack"
3) admin email and password for "mailman" mailing list
4) site password for mailman
5) Default admin account for Mantis: administrator/root
6) Bugzilla administrator password set by ./checksetup.pl
7) Foswiki admin password to save configuration on http://wiki.corp.example.com/bin/configure .
8) ejabberd account password set by "ejabberdctl register"
9) Samba user passwords
10) Default admin account for Redmine: admin/admin
11) Default admin account for Zabbix: Admin/zabbix
12) Account passwords for ReviewBoard, currently its official code
    doesn't support REMOTE_USER yet.


=============================================================
Issues:

If you encounter this error, check whether the keytab file exists
and is readable by slapd.
    $ ldapwhoami
    SASL/GSSAPI authentication started
    ldap_sasl_interactive_bind_s: Other (e.g., implementation specific) error (80)
            additional info: SASL(-1): generic failure: GSSAPI Error: Unspecified GSS failure.  Minor code may provide more information (Unknown error)


If Kerberos authentication fails, check:
  (1) Is service key in xxx.keytab?
  (2) Is xxx.keytab readable?
  (3) Has the service been restarted after xxx.keytab is changed?


Debug Firefox:
    export NSPR_LOG_MODULES=negotiateauth:5
    export NSPR_LOG_FILE=`pwd`/firefox.log
    firefox -console

    export NSPR_LOG_MODULES=all:5
    ...


Kerberos for Windows(KFW) may not be able to save preference on Win 7,
use "Properties" menu item in popup menu to grant yourself write
permission on C:\Windows\krb5.ini, then KFW will create the file
under C:\Users\YOU-ACCOUNT\AppData\Local\VirtualStore\Windows\krb5.ini.


Notice the line length of C:\Windows\System32\Drivers\etc\hosts is
limited, seems no more than 9 host names in single line, you can
use one line for one hostname.

=============================================================
Reference:

Shorewall       http://shorewall.net/

Kerberos        http://web.mit.edu/kerberos/
                http://techpubs.spinlocksolutions.com/dklar/kerberos.html

Cyrus SASL      http://www.cyrusimap.org/docs/cyrus-sasl/

OpenLDAP        http://www.openldap.org/
                http://techpubs.spinlocksolutions.com/dklar/ldap.html

Bind 9          http://www.isc.org/software/bind/documentation

Exim 4          http://wiki.debian.org/PkgExim4
                http://www.exim.org/
                http://www.jcdigita.com/eximconfig/
                /usr/share/doc/exim4-base/README.Debian.gz
                apropos exim

Dovecot         http://dovecot.org/
                http://wiki2.dovecot.org/Pigeonhole/Sieve
                http://wiki2.dovecot.org/Pigeonhole/ManageSieve

Web SSO         http://webauth.stanford.edu/features.html
                https://wiki.jasig.org/display/CAS/Kerberos
                http://www.umich.edu/~umweb/downloads/WebSSOImplementationComparision.pdf
                http://www.jisc.ac.uk/uploaded_documents/CMSS-Gilmore.pdf
                http://et.aset.psu.edu/publications/2003/WebSSO.shtml

SPNEGO          http://mbechler.eenterphace.org/blog/index.php?/archives/6-Doing-GSSNegotiate-SSO-using-Mozilla-Firefox,-MIT-Kerberos-and-PHP.html
                https://developer.mozilla.org/En/Integrated_Authentication
                http://publib.boulder.ibm.com/infocenter/wasinfo/v6r1/index.jsp?topic=%2Fcom.ibm.websphere.base.doc%2Finfo%2Faes%2Fae%2Ftsec_SPNEGO_config_web.html

                http://dev.chromium.org/developers/design-documents/http-authentication
                http://code.google.com/p/chromium/issues/detail?id=28282
                http://code.google.com/p/chromium/issues/detail?id=50065
                http://www.google.com/support/forum/p/Chrome/thread?tid=28894030e871cb94&hl=en
                http://blob.inf.ed.ac.uk/gdutton/2010/11/chrome-and-spnego/
                http://code.google.com/p/chromium/issues/detail?id=50415

                http://linsec.ca/blog/2011/07/26/kerberos-on-os-x-10-7-lion/

                http://social.technet.microsoft.com/wiki/contents/articles/2751.kerberos-interoperability-step-by-step-guide-for-windows-server-2003.aspx

MantisBT        http://www.eiben.weite-welt.com/2010/07/integrated-windows-authentication-in-mantis-updated-to-mantis-1-2-1/

=============================================================
Resource:

Free SSL certificate:   http://cert.startcom.org/

Intepreted Languages:   http://hyperpolyglot.org/scripting
Quickly Understand Ruby: http://www.newsmth.net/bbscon.php?bid=742&id=7963&ftype=11
                         http://www.newsmth.net/nForum/article/Ruby/7963

